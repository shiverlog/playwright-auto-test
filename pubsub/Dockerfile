# Description : Dockerfile - ğŸ“Œ pub/sub Container Image
# Author : Shiwoo Min
# Date : 2024-03-10

# ê²½ëŸ‰ ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì‚¬ìš© (Ubuntu ëŒ€ì‹  Debian Slim)
FROM debian:bookworm-slim AS pubsub

# APT íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (curl, wget, Google Cloud SDK í‚¤ ê´€ë¦¬)
RUN apt-get update
RUN apt-get install -y curl wget gnupg

# Google Cloud SDK ë° Pub/Sub Emulator ì €ì¥ì†Œ ì¶”ê°€
RUN curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | tee /usr/share/keyrings/cloud.google.asc > /dev/null
RUN echo "deb [signed-by=/usr/share/keyrings/cloud.google.asc] https://packages.cloud.google.com/apt cloud-sdk main" | tee /etc/apt/sources.list.d/google-cloud-sdk.list

# Google Cloud SDK ë° Pub/Sub Emulator ì„¤ì¹˜
RUN apt-get update
RUN apt-get install -y google-cloud-sdk pubsub-emulator

# ë¶ˆí•„ìš”í•œ APT ìºì‹œ ì œê±° (ì´ë¯¸ì§€ ìµœì í™”)
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (Pub/Sub ì—ë®¬ë ˆì´í„° í¬íŠ¸ ì„¤ì •)
ENV PUBSUB_EMULATOR_HOST=0.0.0.0:8085

# ì»¨í…Œì´ë„ˆ í¬íŠ¸ ì„¤ì • (Pub/Sub ì—ë®¬ë ˆì´í„° ê¸°ë³¸ í¬íŠ¸)
EXPOSE 8085

# ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ Google Cloud Pub/Sub ì—ë®¬ë ˆì´í„° ì‹¤í–‰
CMD ["gcloud", "beta", "emulators", "pubsub", "start", "--host-port=0.0.0.0:8085"]
