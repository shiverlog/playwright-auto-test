# Description : Dockerfile - ğŸ“Œ DB Container Image
# Author : Shiwoo Min
# Date : 2024-03-10

# ê²½ëŸ‰ Debian ê¸°ë°˜ ì´ë¯¸ì§€ ì‚¬ìš©
FROM debian:bookworm-slim AS builder

# í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (Python2 ìˆ˜ë™ ë¹Œë“œì— í•„ìš”í•œ íŒ¨í‚¤ì§€ í¬í•¨)
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    gcc \
    g++ \
    libssl-dev \
    libsqlite3-dev \
    zlib1g-dev \
    libnuma-dev \
    libibverbs-dev \
    libgflags-dev \
    libgoogle-glog-dev \
    liburing-dev \
    wget \
    tar \
    make \
    curl \
    libbz2-dev \
    libreadline-dev \
    libffi-dev \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Python2 ì†ŒìŠ¤ ì½”ë“œ ë‹¤ìš´ë¡œë“œ ë° ë¹Œë“œ
WORKDIR /usr/src
RUN wget https://www.python.org/ftp/python/2.7.18/Python-2.7.18.tgz && \
    tar xzf Python-2.7.18.tgz && \
    cd Python-2.7.18 && \
    ./configure --enable-optimizations && \
    make -j$(nproc) && \
    make altinstall

# Python2 ì‹¬ë³¼ë¦­ ë§í¬ ì¶”ê°€ (python2ë¥¼ pythonìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ì„¤ì •)
RUN ln -s /usr/local/bin/python2.7 /usr/bin/python2 && ln -s /usr/bin/python2 /usr/bin/python

# Python ë²„ì „ í™•ì¸ (ë””ë²„ê¹…ìš©)
RUN python --version

# MosaicDB ë¹Œë“œ
WORKDIR /app
COPY . /app

# CMakeLists.txtê°€ ìœ„ì¹˜í•œ `mosaic-db` í´ë”ë¡œ ì´ë™
RUN mkdir -p build
WORKDIR /app/build
RUN cmake /app -DCMAKE_BUILD_TYPE=Release && make -j$(nproc)

# ëŸ°íƒ€ì„ ë‹¨ê³„ (ì‹¤í–‰ ì»¨í…Œì´ë„ˆ)
FROM debian:bookworm-slim AS runtime

# í•„ìˆ˜ ëŸ°íƒ€ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ ì„¤ì¹˜
RUN apt-get update && apt-get install -y --no-install-recommends \
    libssl-dev \
    libsqlite3-dev \
    zlib1g-dev \
    libnuma-dev \
    libibverbs-dev \
    libgflags-dev \
    libgoogle-glog-dev \
    liburing-dev \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ì‹¤í–‰ ë””ë ‰í† ë¦¬ ì„¤ì • ë° ì‹¤í–‰ íŒŒì¼ ë³µì‚¬
WORKDIR /app
COPY --from=builder /app/build/ycsb_SI_hybrid_coro /app/mosaic-db

# ë³´ì•ˆ ì •ì±… ìš°íšŒ (SSL ë¬¸ì œ ëŒ€ì‘)
ENV NODE_TLS_REJECT_UNAUTHORIZED=0

# HugePages ë° ë©”ëª¨ë¦¬ ì„¤ì •
RUN echo "512" > /proc/sys/vm/nr_hugepages
RUN echo "root soft memlock unlimited" >> /etc/security/limits.conf && \
    echo "root hard memlock unlimited" >> /etc/security/limits.conf

# í¬íŠ¸ ì„¤ì •
EXPOSE 5000

# HealthCheck ì¶”ê°€
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s \
  CMD curl --fail http://localhost:5000/health || exit 1

# MosaicDB ì‹¤í–‰
ENTRYPOINT ["/app/mosaic-db"]
CMD ["-log_data_dir=/mnt/nvme0n1/mosaicdb-log", \
    "-node_memory_gb=50", \
    "-ycsb_workload=C", \
    "-ycsb_read_tx_type=hybrid-coro", \
    "-seconds=10", \
    "-threads=10"]

# Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ì—¬ 'mosaic-db'ë¼ëŠ” íƒœê·¸ë¥¼ ë¶™ì„
# (í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ Dockerfileì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ)
# docker build -t mosaic-db .

# 'mosaic-db-container'ë¼ëŠ” ì´ë¦„ì„ ì§€ì •í•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œ(-d)ì—ì„œ ì‹¤í–‰
# docker run --name mosaic-db-container -d mosaic-db
