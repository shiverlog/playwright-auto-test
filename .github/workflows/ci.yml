# Description : ci.yml - ğŸ“Œ CI/CD ì›Œí¬í”Œë¡œìš°
# Author : Shiwoo Min
# Date : 2024-03-10

name: CI - Workflow

on:
  workflow_call:

# ì¤‘ë³µëœ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë°©ì§€ (ê°™ì€ ë¸Œëœì¹˜ì—ì„œ ë³‘ë ¬ ì‹¤í–‰ ì¤‘ì´ë©´ ì·¨ì†Œ)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ê³µí†µ í™˜ê²½ ë³€ìˆ˜ ì •ì˜
env:
  NODE_VERSION: 20
  NX_NO_CLOUD: true

jobs:
  # 1. í…ŒìŠ¤íŠ¸ ë‹¨ê³„: Lint / Unit Test / Playwright E2E
  test:
    name: Lint, Unit & Playwright Test
    runs-on: ubuntu-latest

    steps:
      # ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # Node.js ì„¤ì • (ë²„ì „: 20)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # ì˜ì¡´ì„± ì„¤ì¹˜ (npm ê¸°ì¤€)
      - name: Install dependencies (npm)
        run: npm ci

      # Lint ì‹¤í–‰ (ì˜¤ë¥˜ê°€ ë‚˜ë„ ê³„ì† ì§„í–‰)
      - name: Run Lint
        run: npm run lint
        continue-on-error: true

      # ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run Unit Tests
        run: npm test

  # 2. ë¹Œë“œ ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: test # í…ŒìŠ¤íŠ¸ jobì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë¨
    permissions:
      id-token: write
      contents: read

    steps:
      # ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ Git íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (Nx ë¹Œë“œ ë¶„ì„ì— í•„ìš”)

      # AWS ìê²© ì¦ëª… ì„¤ì • (í•„ìš” ì‹œ ì£¼ì„ í•´ì œ)
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v2
      #   with:
      #     role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      #     aws-region: ${{ secrets.AWS_REGION }}
      #     role-session-name: ci-session

      # pnpm ì„¤ì •
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # Node.js ì„¤ì • (pnpm ìš©)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # ì˜ì¡´ì„± ì„¤ì¹˜ (pnpm ê¸°ì¤€)
      - name: Install dependencies (pnpm)
        run: pnpm install --frozen-lockfile

      # ì˜í–¥ ë°›ì€ í”„ë¡œì íŠ¸ ë¹Œë“œ (Nx ê¸°ë°˜)
      - name: Build affected projects (Nx)
        run: |
          BASE_BRANCH=$(git rev-parse HEAD^)
          pnpm nx affected --target=build --base=$BASE_BRANCH --head=HEAD --parallel=3

      # ì˜í–¥ ë°›ì€ ì•± ê¸°ì¤€ìœ¼ë¡œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker images
        env:
          IMAGE_NAME: ${{ github.repository }}
        run: |
          BASE_BRANCH=$(git rev-parse HEAD^)
          AFFECTED_PROJECTS=$(pnpm nx show projects --affected --type app --base=$BASE_BRANCH --head=HEAD)

          # ê³µë°± ì •ë¦¬ ë° ë°°ì—´í™”
          AFFECTED_PROJECTS=$(echo "$AFFECTED_PROJECTS" | tr -s '[:space:]' ' ')
          IFS=' ' read -r -a PROJECTS <<< "$AFFECTED_PROJECTS"

          for project in "${PROJECTS[@]}"; do
            FINAL_IMAGE_NAME="${IMAGE_NAME}-${project}"
            echo "Building image: $FINAL_IMAGE_NAME"
            docker build --build-arg="BUILD_ENV=${BUILD_ENV}" -t $FINAL_IMAGE_NAME -f apps/$project/Dockerfile .
            docker push $FINAL_IMAGE_NAME
          done
