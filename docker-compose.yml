# Description : docker-compose.yml - ğŸ“Œ Dockerizing ì‹¤í–‰ í™˜ê²½ ì •ì˜ íŒŒì¼
# Author : Shiwoo Min
# Date : 2024-03-10

version: '3.9'

networks:
  app_network: # ê³µí†µ ë„¤íŠ¸ì›Œí¬ ì •ì˜
    driver: bridge

volumes:
  common_data: # common ì»¨í…Œì´ë„ˆì—ì„œ ì‚¬ìš©í•  ë³¼ë¥¨
    driver: local

services:
  # common íŒ¨í‚¤ì§€ ì»¨í…Œì´ë„ˆ
  common:
    build:
      # ìµœìƒë‹¨ ë£¨íŠ¸ë¡œ context ì„¤ì •
      context: .
      dockerfile: common/Dockerfile
    image: common-module:latest
    container_name: common
    restart: unless-stopped
    networks:
      - app_network
    volumes:
      - common_data:/app/common
    working_dir: /app/common
    command: ['tail', '-f', '/dev/null']

  playwright:
    build: .
    container_name: playwright_tests
    networks:
      - app_network
    depends_on:
      - common
    volumes:
      - .:/app
    working_dir: /app
    # Playwright í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    command: ['npx', 'playwright', 'test']
    # ê³µìœ  ë©”ëª¨ë¦¬ í¬ê¸° ì„¤ì • (ë¸Œë¼ìš°ì € ì•ˆì •í™”)
    shm_size: '2gb'
#   # E2E í…ŒìŠ¤íŠ¸ - PC Web
#   e2e-pc:
#     build:
#       context: ./e2e/pc-web
#       dockerfile: Dockerfile
#     container_name: e2e_pc
#     depends_on:
#       - common
#     networks:
#       - app_network
#     volumes:
#       - e2e_pc_data:/app/results
#     environment:
#       - NODE_ENV=test

#   # E2E í…ŒìŠ¤íŠ¸ - Mobile Web
#   e2e-mw:
#     build:
#       context: ./e2e/mobile-web
#       dockerfile: Dockerfile
#     container_name: e2e_mw
#     depends_on:
#       - common
#     networks:
#       - app_network
#     volumes:
#       - e2e_mw_data:/app/results
#     environment:
#       - NODE_ENV=test

#   # E2E í…ŒìŠ¤íŠ¸ - AOS (Android)
#   e2e-aos:
#     build:
#       context: ./e2e/android
#       dockerfile: Dockerfile
#     container_name: e2e_aos
#     depends_on:
#       - common
#     networks:
#       - app_network
#     volumes:
#       - e2e_aos_data:/app/results
#     environment:
#       - NODE_ENV=test

#   # E2E í…ŒìŠ¤íŠ¸ - iOS
#   e2e-ios:
#     build:
#       context: ./e2e/ios
#       dockerfile: Dockerfile
#     container_name: e2e_ios
#     depends_on:
#       - common
#     networks:
#       - app_network
#     volumes:
#       - e2e_ios_data:/app/results
#     environment:
#       - NODE_ENV=test

#   # E2E í…ŒìŠ¤íŠ¸ - API
#   e2e-api:
#     build:
#       context: ./e2e/api
#       dockerfile: Dockerfile
#     container_name: e2e_api
#     depends_on:
#       - common
#     networks:
#       - app_network
#     volumes:
#       - e2e_api_data:/app/results
#     environment:
#       - NODE_ENV=test

#   # 3ì‚¬ ì†ë„ í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤
#   speedtest:
#     build:
#       context: ./speedtest
#       dockerfile: Dockerfile
#     container_name: speedtest_service
#     networks:
#       - app_network
#     volumes:
#       - speedtest_data:/app/results
#     environment:
#       - NODE_ENV=production

#   networks:
#     app_network:
#       driver: bridge

#   # Pub/Sub ì„œë¹„ìŠ¤
#   pubsub:
#     build:
#       context: ./pubsub
#       dockerfile: Dockerfile
#     container_name: pubsub_service
#     depends_on:
#       - common
#     networks:
#       - app_network
#     volumes:
#       - pubsub_data:/app/data
#     environment:
#       - NODE_ENV=production
#         # Google Pub/Sub ì—ë®¬ë ˆì´í„° í˜¸ìŠ¤íŠ¸ (ë¡œì»¬ ì‹¤í–‰ ì‹œ)
#       - PUBSUB_EMULATOR_HOST=0.0.0.0:8085

#   # Mosaic DB ì—°ë™
#   mosaic-db:
#     build: ./mosaic-db
#     container_name: mosaic-db
#     restart: unless-stopped
#     volumes:
#       - ./db/conf.d:/etc/mosaic-db/conf.d
#       - ./db/initdb.d:/docker-entrypoint-initdb.d
#     ports:
#       - '5000:5000'
#     environment:
#       - NODE_ENV=production
#       - DB_HOST=db
#       - DB_USER=user
#       - DB_PASS=password
#       - DB_DATABASE=test
#       - DB_ROOT_PASSWORD=test1234
#       - TZ=Asia/Seoul
#     depends_on:
#       - db

#   db:
#     image: postgres:15-alpine
#     environment:
#       POSTGRES_USER: user
#       POSTGRES_PASSWORD: password
#       POSTGRES_DB: mosaic
#     ports:
#       - '5432:5432'
#     volumes:
#       - db-data:/var/lib/postgresql/data

# volumes:
#   db-data:

# docker-compose up --build
# docker-compose version
# docker-compose config
